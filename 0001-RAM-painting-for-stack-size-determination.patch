From 4070359c270e6d7406fa92cd6032002671c4f020 Mon Sep 17 00:00:00 2001
From: Oleg Artamonov <oleg@unwds.com>
Date: Fri, 8 Mar 2019 20:42:11 +0300
Subject: [PATCH] RAM painting for stack size determination

---
 include/libopencm3/cm3/common.h | 3 +++
 lib/cm3/vector.c                | 7 +++++++
 2 files changed, 10 insertions(+)

diff --git libopencm3/include/libopencm3/cm3/common.h libopencm3/include/libopencm3/cm3/common.h
index a7a8df8d..59057185 100644
--- libopencm3/include/libopencm3/cm3/common.h
+++ libopencm3/include/libopencm3/cm3/common.h
@@ -23,6 +23,9 @@
 #include <stdint.h>
 #include <stdbool.h>
 
+/* Used for stack size calculation */
+#define STACK_CANARY_WORD (0xCACACACAUL)
+
 /* This must be placed around external function declaration for C++
  * support. */
 #ifdef __cplusplus
diff --git libopencm3/lib/cm3/vector.c libopencm3/lib/cm3/vector.c
index af92ed72..e6cc7ec9 100644
--- libopencm3/lib/cm3/vector.c
+++ libopencm3/lib/cm3/vector.c
@@ -63,6 +63,13 @@ void __attribute__ ((weak)) reset_handler(void)
 {
 	volatile unsigned *src, *dest;
 	funcp_t *fp;
+    
+    volatile unsigned *top;
+    __asm__ volatile ("mov %[top], sp" : [top] "=r" (top) : : );
+    dest = &_ebss;
+    while (dest < top) {
+        *(dest++) = STACK_CANARY_WORD;
+    }
 
 	for (src = &_data_loadaddr, dest = &_data;
 		dest < &_edata;
-- 
2.17.1

